{% extends 'base_test.html' %}

{% block content %}

<div id="find-function">

    <div id = "similar-task">
        <!--  Create button for user to Run matchCat. Only allow user that create this very post to run it -->
       <h1> Chạy tìm kiếm ngay lập tức</h1>

        <button id="runSimilarButton" class="button is-primary" data-post-id="{{ post_id }}">Tìm kiếm</button>
  
        <div id="similarResults" style="display: none;">
            <h3>Similar Posts:</h3>
            <ul id="similarPostsList"></ul>
        </div>
        </div>

    <div id="schedule-task">
        <h1>Nhập email để nhận thông báo về kết quả tìm kiếm</h1>
        <form method="POST">
            {% csrf_token %}
            <div class="field">
                <label class="label">Email</label>
                <div class="control has-icons-left has-icons-right">
                  <input class="input" type="email" placeholder="Email input">
                  <span class="icon is-small is-left">
                    <i class="fas fa-envelope"></i>
                  </span>
                  <span class="icon is-small is-right">
                    <i class="fas fa-exclamation-triangle"></i>
                  </span>
                </div>
              </div>

              <div class="field">
                <div class="control">
                  <label class="checkbox">
                    <input type="checkbox">
                    Xác nhận đặt lịch chạy 1 lần/ 1 giờ</a>
                  </label>
                </div>
              </div>

              <div class="field is-grouped">
                <div class="control">
                  <button class="button is-link">Submit</button>
                </div>
                <div class="control">
                  <button class="button is-link is-light">Cancel</button>
                </div>
              </div>
        </form>

    </div>


</div>

<div id="find-result">
    <h1>Lịch sử kết quả tìm kiếm</h1>
<ul>
    {% for result in results %}
        <li>
            <h2>{{ result.created }}</h2>
            <ol>
                {% for post in result.posts %}
                <li><a href="{{ post }}">Link</a></li>
                {% endfor %}
            </ol>
        </li>
    {% endfor %}
</ul>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    const runSimilarButton = document.getElementById('runSimilarButton');
    const similarResults = document.getElementById('similarResults');
    const similarPostsList = document.getElementById('similarPostsList');

    if (runSimilarButton) {
        runSimilarButton.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            runSimilarButton.disabled = true;
            runSimilarButton.textContent = 'Searching...';
            
            fetch(`/post/find-similar/${postId}/`)
                .then(response => response.json())
                .then(data => {
                    similarPostsList.innerHTML = '';
                    data.similar_posts.forEach(post => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = post.url;
                        a.textContent = post.title || 'Similar Post'; // Use post title if available, otherwise use 'Similar Post'
                        a.target = '_blank'; // Open the link in a new tab
                        li.appendChild(a);
                        similarPostsList.appendChild(li);
                    });
                    similarResults.style.display = 'block';
                    runSimilarButton.disabled = false;
                    runSimilarButton.textContent = 'Run Similar Search';
                })
                .catch(error => {
                    console.error('Error:', error);
                    similarResults.innerHTML = '<p>An error occurred while searching for similar posts.</p>';
                    similarResults.style.display = 'block';
                    runSimilarButton.disabled = false;
                    runSimilarButton.textContent = 'Run Similar Search';
                });
        });
    }
});
</script>

{% endblock %}