
{% extends "base_test.html" %}
{% load static %}
{% block title %}Images of {{ cat.name }}{% endblock %}

{% block styles %}
<style>

body {

    /* background-image: url("{% static 'img/cat_paw_fish.jpg' %}");
    background-image: repeat;
    background-size:auto; */
    background-color: #fce4ec;
  }


  .post-item {
    width:20%;
    margin-bottom: 20px;
    
    img {
      width: 100%;
      border-radius: 10px;
      
    }
    

  }

  .delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    color: #fff;
    background-color: #dc3545;
    border: none;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;


  }

  .blue-button {
    position: fixed;
    color: #fff;
    bottom: 50px;
    left: 50px;
    background-color: #3835dc;
    border: none;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;

  }

  .green-button {
    position: fixed;
    color: #fff;
    bottom: 50px;
    left: 200px;
    background-color: #447c47;
    border: none;
    padding: 6px 12px;
    font-size: 14px;
    cursor: pointer;

  }

  .modal {
    display: none;
    position: fixed;
    z-index: 2;
    /* Increased */
    left: 0;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.4);
  }

  .modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 30%;
    position: relative;
    /* Added */
    z-index: 3;
    /* Added */
  }

  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
  }

  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .modal-buttons {
    text-align: center;
    margin-top: 20px;
  }

  .modal-buttons button {
    margin: 0 10px;
  }

  .sidebar-fixed {
  margin-top: 50px;
  padding: 0px 5px;
  position: fixed;
  width: 20%;
  height: 100%;
  top: 0;
  left: 0;
  color: #777;
}

.cat-bottom {
  position: fixed;
  margin-bottom: 50px;
  bottom: 0;
}
</style>

{% endblock %}

{% block scripts %}

<script src="{% static 'js/masonry.pkgd.js' %}"> </script>
<script src="{% static 'js/mason.js' %}"></script>
{% endblock %}

{% block content %}


  <div class="background-image">


  <div class="sidebar-fixed card">

    <div class="card-content">
      <div class="media">
          <div class="media-content">
              <p class="title is-4">{{ cat.name }}</p>
          </div>
      </div>
      <div class="content">
          {{ cat.description }}
      </div>

      <div class = "func">

        {% if not message %}
        <button id="add_cat_img">Add Cat Image</button>
        <div><a href="{% url 'authy:create-emb-vector' cat.id %}">Create Embedding Vector</a></div>
        {% else %}
        {% endif %}


      </div>

      <div class="cat-bottom">
        <ul>
          <h2>Other cats</h2>
          {% for one in cats %}
          {% if one.id != cat.id %}
          <li>
            <a href ="{% url 'authy:cat-detail' one.id %}">{{ one.name }}</a>
          </li>
          {% endif %}
          {% endfor %}

        </ul>

          
      </div>
  </div>

  </div>
  <h1>{{ cat.name }} Image Storage </h1>


  <div id="cat_image_modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add Cat Image</h2>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Upload</button>
        </form>
    </div>
</div>
</div>
  <div class="post-container">
    {% for img in img_list %}
    <div class="post-item">

      <img data-code="{{ img.id }}" src="{{ img.pic.url }}">
      <button class="delete-btn" id="cat-{{ img.id }}" data-post-id= "{% url 'authy:cat-img-delete' img.id %}">Delete</button>

    </div>

    {% empty %}
    <h2>You have not added any images for {{ cat.name }}</h2>
    {% endfor %}
  </div>

  <div id="confirmation-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <p>Are you sure you want to delete this post?</p>
      <div class="modal-buttons">
        <button id="confirm-delete">Confirm</button>
        <button id="cancel-delete">Cancel</button>
      </div>
    </div>
  </div>

</div>
</div>

  <script> 

      var modal = document.getElementById('cat_image_modal');
      var btn = document.getElementById('add_cat_img');
      const closeModal = document.getElementsByClassName('close')[0];
      
      btn.onclick = function() {
          modal.style.display = "block";
          console.log('add image button clicked!');
      }

      // span.onclick = function() {
      //   console.log('close modal clicked!')
      //     modal.style.display = 'none';
      // }

      window.onclick = function(event) {
          if (event.target == modal) {
              modal.style.display = "none";
          }
      }

    const deleteBtns = document.querySelectorAll('.delete-btn');
    const confirmationModal = document.getElementById('confirmation-modal');
    
    const confirmDeleteButton = document.getElementById('confirm-delete');
    const cancelDeleteButton = document.getElementById('cancel-delete');

    let postToDelete;
    // let urlPostToDelete;

    // Show the confirmation modal
    function showConfirmationModal(postId) {
      postToDelete = postId;
      // urlPostToDelete = this.data['update-url'];
      confirmationModal.style.display = 'block';
    }

    // Close the confirmation modal
    function closeConfirmationModal() {
      confirmationModal.style.display = 'none';
      postToDelete = null;
    }
    function closeAddImageModal(){
      modal.style.display = 'none';
    }

    // Handle delete confirmation
    function handleDeleteConfirmation() {
      if (postToDelete) {
        console.log(`Deleting post with ID ${postToDelete}`);
        // console.log(`Url of Post to delete ${urlPostToDelete}`);
        // const deleteUrl = Urls.reverse('authz:cat-img-delete', [postToDelete]);
        // Implement code to delete the post from the server
        fetch(postToDelete, {

          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          },

        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              console.log(`Post with ID ${postToDelete} deleted successfully`);
              // Optionally, you can remove the post from the DOM
              
              const deleteElement = document.querySelector(`[data-post-id = "${postToDelete}"]`);
              const deletePost = deleteElement.closest('.post-item');
              console.log(`Deleted Post ${deletePost}`);
              if (deletePost){
                deletePost.remove();
              }
            } else {
              console.error('Failed to delete post');
            }
            closeConfirmationModal();
          })
          .catch(error => {
            console.error('Error:', error);
            closeConfirmationModal();
          });
      }
    }
    // Helper function to get the CSRF token
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }



    // Handle delete cancellation
    function handleDeleteCancellation() {
      closeConfirmationModal();
    }

    // Close the modal when the close button or outside the modal is clicked
    closeModal.onclick = closeConfirmationModal;
    window.onclick = function (event) {
      if (event.target === confirmationModal) {
        closeConfirmationModal();
      }
    }

    closeModal.onclick = closeAddImageModal;

    // Event listeners for confirmation and cancellation buttons
    confirmDeleteButton.addEventListener('click', handleDeleteConfirmation);
    cancelDeleteButton.addEventListener('click', handleDeleteCancellation);

    // Add event listeners to delete buttons
    deleteBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const postId = btn.dataset.postId;
        showConfirmationModal(postId);
      });
    });
  </script>
  
{% endblock %}